<div class="container mx-auto p-4">
    <h1 class="text-2xl font-bold mb-6">{{ 'config.title' | translate }}</h1>
    <div class="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Theme (left, 1x1) -->
        <div class="col-span-1">
            <div class="bg-base-100 p-6 rounded-lg shadow border border-base-300 h-full">
                <app-theme-selector [theme]="theme" (themeChange)="onThemeChange($event)"></app-theme-selector>
            </div>
        </div>

        <!-- Currency settings (right, spans 2 columns vertically) -->
        <div class="col-span-1 md:col-span-2 md:row-span-2">
            <div class="bg-base-100 p-6 rounded-lg shadow border border-base-300 h-full">
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                    <h2 class="text-xl font-semibold">{{ 'config.currencySettings' | translate }}</h2>
                </div>

                <div class="grid gap-4 mt-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">{{ 'config.currency' | translate }}</label>
                        <select [(ngModel)]="config.currency" class="select select-bordered w-full">
                            <option value="USD">Dólar Estadounidense (USD)</option>
                            <option value="EUR">Euro (EUR)</option>
                            <option value="GBP">Libra Esterlina (GBP)</option>
                            <option value="JPY">Yen Japonés (JPY)</option>
                            <option value="CNY">Yuan Chino (CNY)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">{{ 'config.format' | translate }}</label>
                        <select [(ngModel)]="config.currencyDisplay" class="select select-bordered w-full">
                            <option value="symbol">Símbolo (€, $, £)</option>
                            <option value="code">Código (EUR, USD, GBP)</option>
                            <option value="name">Nombre (euro, dólar, libra)</option>
                        </select>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">{{ 'config.region' | translate }}</label>
                        <select [(ngModel)]="config.locale" class="select select-bordered w-full">
                            <option value="en-US">Estados Unidos (en-US)</option>
                            <option value="es-ES">España (es-ES)</option>
                        </select>
                    </div>

                    <div class="mt-6 p-4 bg-base-200 rounded-lg">
                        <h3 class="font-semibold mb-2">{{ 'config.preview' | translate }}</h3>
                        <p>
                            {{ 'config.previewText' | translate }}
                            {{ 1234.56 | currency:config.currency:'symbol':'1.2-2':config.locale}}
                        </p>
                    </div>

                    <div class="mt-4">
                        <button (click)="saveConfig()" class="btn btn-primary">
                            {{ 'config.save' | translate }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Import (below theme, left column) -->
        <div class="col-span-1">
            <div class="bg-base-100 p-6 rounded-lg shadow border border-base-300 h-full">
                <h2 class="text-xl font-semibold mb-4">{{ 'config.importExcel' | translate }}</h2>

                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-2">{{ 'config.selectFile' | translate }}</label>
                        <input type="file" accept=".xlsx,.xls" (change)="onFileSelected($event)"
                            class="file-input file-input-bordered w-full" [disabled]="isImporting" />
                        <p class="text-xs text-gray-500 dark:text-gray-400 mt-2">
                            {{ 'config.fileFormat' | translate }}
                        </p>
                    </div>

                    <div *ngIf="selectedFile" class="p-3 bg-base-200 rounded">
                        <p class="text-sm">
                            <strong>{{ 'config.selectedFile' | translate }}:</strong> {{ selectedFile.name }}
                        </p>
                    </div>

                    <button (click)="importExcel()" class="btn btn-primary" [disabled]="!selectedFile || isImporting">
                        <span *ngIf="!isImporting">{{ 'config.import' | translate }}</span>
                        <span *ngIf="isImporting">{{ 'config.importing' | translate }}...</span>
                    </button>

                    <!-- Resultado de la importación -->
                    <div *ngIf="importResult" class="mt-4">
                        <div *ngIf="importResult.success" class="alert alert-success">
                            <div>
                                <strong>{{ 'config.importSuccess' | translate }}</strong>
                                <div *ngIf="importResult.results" class="mt-2 text-sm">
                                    <p>{{ 'config.successCount' | translate }}: {{ importResult.results.success }}</p>
                                    <p *ngIf="importResult.results.failed > 0" class="text-error">
                                        {{ 'config.failedCount' | translate }}: {{ importResult.results.failed }}
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div *ngIf="!importResult.success" class="alert alert-error">
                            <div>
                                <strong>{{ 'config.importError' | translate }}</strong>
                                <p>{{ importResult.error }}</p>
                                <div *ngIf="importResult.results?.errors && importResult.results.errors.length > 0"
                                    class="mt-2">
                                    <p class="font-semibold">{{ 'config.errors' | translate }}:</p>
                                    <ul class="list-disc list-inside text-sm">
                                        <li *ngFor="let err of importResult.results.errors.slice(0, 5)">
                                            {{ 'config.row' | translate }} {{ err.row }}: {{ err.error }}
                                        </li>
                                        <li *ngIf="importResult.results.errors.length > 5" class="text-gray-500">
                                            ... {{ 'config.andMore' | translate }} {{ importResult.results.errors.length
                                            - 5 }}
                                            {{ 'config.moreErrors' | translate }}
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Categorías -->
    <div class="mt-6 bg-base-100 p-6 rounded-lg shadow border border-base-300">
        <h2 class="text-xl font-semibold mb-4">{{ 'categories.title' | translate }}</h2>

        <!-- Crear nueva categoría -->
        <form [formGroup]="categoryForm" class="flex flex-col md:flex-row items-stretch md:items-center gap-3 w-full"
            (ngSubmit)="createCategory()">
            <!-- Color picker (arriba en móvil) -->
            <div class="order-1 md:order-1 flex-shrink-0">
                <app-color-picker [colors]="allowedColors" [value]="categoryForm.get('color')?.value"
                    (valueChange)="categoryForm.patchValue({ color: $event })">
                </app-color-picker>
            </div>

            <!-- Input nombre (medio en móvil) -->
            <div class="order-2 md:order-2 flex-1 w-full">
                <input formControlName="name" class="input input-bordered w-full truncate"
                    [placeholder]="'categories.name' | translate"
                    [class.input-error]="categoryForm.get('name')?.invalid && categoryForm.get('name')?.touched" />
            </div>

            <!-- Botón (abajo en móvil, derecha en desktop) -->
            <div class="order-3 md:order-3 w-full md:w-auto">
                <button type="submit" class="btn btn-primary w-full md:w-auto min-h-[44px]"
                    [disabled]="!categoryForm.valid">
                    {{ 'categories.add' | translate }}
                </button>
            </div>
        </form>

        <!-- Lista de categorías -->
        <ul class="space-y-3 mt-6">
            <li *ngFor="let c of categories"
                class="flex items-center justify-between p-4 bg-base-100 border border-base-300 rounded-lg shadow-sm hover:shadow-md transition-shadow">
                @if (editingCategoryId === c.id) {
                <!-- Modo edición -->
                <form [formGroup]="editCategoryForm"
                    class="flex flex-col md:flex-row items-stretch md:items-center gap-3 w-full"
                    (ngSubmit)="saveCategory(c.id)">
                    <!-- Color picker -->
                    <div class="order-1 md:order-1 flex-shrink-0">
                        <app-color-picker [colors]="allowedColors" [value]="editCategoryForm.get('color')?.value"
                            (valueChange)="editCategoryForm.patchValue({ color: $event })">
                        </app-color-picker>
                    </div>

                    <!-- Input -->
                    <div class="order-2 md:order-2 flex-1 w-full">
                        <input formControlName="name" class="input input-bordered flex-1 h-[2.6rem] w-full truncate"
                            [class.input-error]="editCategoryForm.get('name')?.invalid && editCategoryForm.get('name')?.touched" />
                    </div>

                    <!-- Botones -->
                    <div class="order-3 md:order-3 w-full md:w-auto flex gap-2">
                        <button type="submit" class="btn btn-md btn-success flex-1 md:flex-none min-h-[44px] rounded"
                            [disabled]="!editCategoryForm.valid" [attr.aria-label]="'categories.save' | translate"
                            [title]="'categories.save' | translate">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M16.5 3.75V16.5L12 14.25 7.5 16.5V3.75m9 0H18A2.25 2.25 0 0 1 20.25 6v12A2.25 2.25 0 0 1 18 20.25H6A2.25 2.25 0 0 1 3.75 18V6A2.25 2.25 0 0 1 6 3.75h1.5m9 0h-9" />
                            </svg>
                        </button>
                        <button type="button" class="btn btn-md btn-ghost flex-1 md:flex-none min-h-[44px] rounded"
                            (click)="cancelEditing()" [attr.aria-label]="'categories.cancel' | translate"
                            [title]="'categories.cancel' | translate">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                                stroke="currentColor" class="w-5 h-5">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="M9 15 3 9m0 0 6-6M3 9h12a6 6 0 0 1 0 12h-3" />
                            </svg>
                        </button>
                    </div>
                </form>
                } @else {
                <!-- Modo visualización -->
                <div class="flex items-center gap-3 flex-1">
                    <div class="px-4 py-2 rounded-lg font-medium shadow-sm transition-all hover:shadow-md"
                        [ngClass]="!isHex(c.color) ? getBgClass(c.color+'') : ''"
                        [style.background]="isHex(c.color) ? c.color : null"
                        [style.color]="getContrastColorMaybe(c.color)">
                        {{ c.name }}
                    </div>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-md btn-primary min-h-[44px] min-w-[44px] rounded" (click)="startEditing(c)"
                        [attr.aria-label]="'categories.edit' | translate" title="{{ 'categories.edit' | translate }}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                        </svg>
                    </button>
                    <button class="btn btn-md btn-error min-h-[44px] min-w-[44px] rounded"
                        (click)="deleteCategory(c.id)" [attr.aria-label]="'categories.delete' | translate"
                        title="{{ 'categories.delete' | translate }}">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                        </svg>
                    </button>
                </div>
                }
            </li>
        </ul>
    </div>
</div>